<!DOCTYPE html>
<html>
<head>
    <title>Leaflet - BC Geocoder API with OpenStreetMap and Leaflet</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/smoothness/jquery-ui.css" />
    <style>
        .ui-autocomplete {
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map" style="height: 500px;"></div>
    <input id="geocodeField" type="search" placeholder="Enter a civic address" style="position: absolute; top: 20px; left: 60px;z-index: 1000;">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>
    <script>
        var map = L.map('map').setView([49.2827, -123.1207], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        var searchInput = document.getElementById('geocodeField');
        var results = L.layerGroup().addTo(map);

        function geocodeAddress() {
            var address = searchInput.value.trim();
            if (address !== '') {
                var url = 'https://geocoder.api.gov.bc.ca/addresses.json?addressString=' + encodeURIComponent(address) + '&minScore=80&maxResults=1';

                fetch(url)
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (data) {
                        results.clearLayers();
                        if (data.features.length > 0) {
                            var feature = data.features[0];
                            var coordinates = feature.geometry.coordinates;
                            var latlng = L.latLng(coordinates[1], coordinates[0]);
                            var marker = L.marker(latlng).addTo(map);
                            marker.bindPopup(formatAddress(feature.properties)).openPopup();
                            results.addLayer(marker);
                            map.setView(latlng, 13);
                        } else {
                            alert('Address not found');
                        }
                    })
                    .catch(function (error) {
                        console.error('Error:', error);
                        alert('An error occurred during geocoding');
                    });
            }
        }

        var gcApi = "https://geocoder.api.gov.bc.ca/";

        // Geocode Address autocomplete
        $('#geocodeField').autocomplete({
            minLength: 3,
            source: function (request, response) {
                var params = {
                    minScore: 50,
                    maxResults: 3,
                    echo: 'false',
                    brief: true,
                    autoComplete: true,
                    addressString: request.term
                };
                $.ajax({
                    url: gcApi + "addresses.json",
                    data: params,
                    success: function (data) {
                        var list = [];
                        if (data.features && data.features.length > 0) {
                            list = data.features.map(function (item) {
                                return {
                                    value: item.properties.fullAddress,
                                    data: item
                                };
                            });
                        }
                        response(list);
                    },
                    error: function () {
                        response([]);
                    }
                });
            },
            select: function (evt, ui) {
                $('#output').text(JSON.stringify(ui.item.data, null, 4));
                geocodeAddress(); // Geocode the selected address
            }
        });

        function formatAddress(properties) {
            var address = properties.fullAddress;
            return address;
        }

        document.getElementById('geocodeField').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                geocodeAddress();
            }
        });
    </script>
</body>
</html>
